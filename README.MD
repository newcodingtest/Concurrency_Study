
1. synchronized ëŠ” í•˜ë‚˜ì˜ í”„ë¡œì„¸ì„œ(í•˜ë‚˜ì˜ ì„œë²„) ì—ì„œë§Œ ìœ íš¨í•˜ë‹¤. 2ê°œ ì´ìƒì˜ ì„œë²„ì¼ ê²½ìš° ë™ì‹œì„± ì´ìŠˆê°€ ë°œìƒí•œë‹¤.

1ì˜ ë¬¸ì œë¥¼ í•´ê²° í•´ê²°í•˜ê¸° ìœ„í•œ ë°©ë²•ì€??

1. MySql Lock
    1. Pesimistic Lock
    2. Optimistic Lock
    3. Named Lock


**1. Pessimistic Lock**

- ì‹¤ì œë¡œ ë°ì´í„°ì— Lockì„ ê±¸ì–´ì„œ ì •í•©ì„±ì„ ë§ì¶”ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
- exclusive lock(ë² íƒ€ì  ì ê¸ˆ) ì„ ê±¸ê²Œë˜ë©´ ë‹¤ë¥¸ íŠ¸ëœì­ì…˜ì—ì„œëŠ” lock ì´ í•´ì œë˜ê¸°ì „ì— ë°ì´í„°ë¥¼ ê°€ì ¸ê°ˆ ìˆ˜ ì—†ê²Œë©ë‹ˆë‹¤.
- âœ¨ ìì› ìš”ì²­ì— ë”°ë¥¸Â **ë™ì‹œì„±ë¬¸ì œê°€ ë°œìƒí•  ê²ƒì´ë¼ê³  ì˜ˆìƒí•˜ê³  ë½**ì„ ê±¸ì–´ë²„ë¦¬ëŠ”Â **ë¹„ê´€ì  ë½**Â ë°©ì‹ì…ë‹ˆë‹¤.
- í•˜ì§€ë§Œ, ë°ë“œë½ì´ ê±¸ë¦´ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì£¼ì˜í•˜ì—¬ ì‚¬ìš©í•´ì•¼í•©ë‹ˆë‹¤.

![](https://blog.kakaocdn.net/dn/6oWmB/btrNviyzlKp/oo6trLHChrh96LQIyz3UlK/img.png)

Pessimistic Lock

ì˜ˆë¥¼ë“¤ì–´ Server 1 DB ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ë–„, Lock ì„ ê±¸ì–´ë²„ë¦¬ë©´, ë‹¤ë¥¸ ì„œë²„ì—ì„œëŠ” Server1ì˜ ì‘ì—…ì´ ëë‚˜ ë½ì´ í’€ë¦´ ë•Œ ê¹Œì§€, ë°ì´í„°ì— ì ‘ê·¼í•˜ì§€ ëª»í•˜ê²Œ ë©ë‹ˆë‹¤.

- ì¥ì 
    - ì¶©ëŒì´ ë¹ˆë²ˆíˆ ì¼ì–´ë‚˜ë©´ Optimistic Lockë³´ë‹¤ ì„±ëŠ¥ì´ ì¢‹ìŒ
    - ë½ì„ í†µí•œ updateì¸í•œ ë°ì´í„° ì •í•©ì„± ë³´ì¥

- ë‹¨ì 
    - ë³„ë„ì˜ lockì„ ì ìœ í•˜ê³  ìˆê¸°ì— ì„±ëŠ¥ ë¬¸ì œ ë°œìƒ ê°€ëŠ¥ì„±ì´ ì¡´


**ì„œë¹„ìŠ¤**
```
@Service  
public class PessimisticLockStockService {  
  
@Autowired  
private StockRepository stockRepository;  
  
	public void decrease(Long id, Long quantity){  
		Stock stock = stockRepository.findByIdWithPessimisticLock(id);  
		  
		stock.decrease(quantity);  
		  
		stockRepository.saveAndFlush(stock);  
	}  
}
```

**ë ˆí¬ì§€í† ë¦¬**
```
@Repository  
public interface StockRepository extends JpaRepository<Stock,Long> {  
  
/**  
* ë¹„ê´€ì  ë½(Pessimistic Lock)  
*  
*/  
@Lock(value = LockModeType.PESSIMISTIC_WRITE)  
@Query("select s from Stock s where s.id = :id")  
Stock findByIdWithPessimisticLock(@Param("id") final Long id);  
}```


```


**í…ŒìŠ¤íŠ¸ ì½”ë“œ**
```
@Test  
public void ë¹„ê´€ì _ë½ì„_ì ìš©í•˜ì—¬_ë™ì‹œì—_100ê°œì˜_ìš”ì²­() throws InterruptedException {  
	int threadCnt = 100;  
	  
	ExecutorService executorService = Executors.newFixedThreadPool(32);  
	CountDownLatch latch = new CountDownLatch(threadCnt);  
	  
	  
	for (int i=0; i< threadCnt; i++){  
		executorService.submit(() -> {  
			try{  
				pessimisticLockStockService.decrease(1l,1l);  
			}finally {  
				latch.countDown();  
			}  
		  
		});  
	}  
	latch.await();  
	  
	Stock stock = stockRepository.findById(1L).orElseThrow();  
	  
	assertEquals(0L,stock.getQuantity());  
}
```


**2. Optimisitc Lock**

- ì‹¤ì œë¡œ Lock ì„ ì´ìš©í•˜ì§€ ì•Šê³ Â **ë²„ì „**ì„ ì´ìš©í•¨ìœ¼ë¡œì¨ ì •í•©ì„±ì„ ë§ì¶”ëŠ” ë°©ë²•ì…ë‹ˆë‹¤.
- ë¨¼ì € ë°ì´í„°ë¥¼ ì½ì€ í›„ì— update ë¥¼ ìˆ˜í–‰í•  ë–„ í˜„ì¬Â **ë‚´ê°€ ì½ì€ ë²„ì „ì´ ë§ëŠ”ì§€ í™•ì¸**í•˜ë©° ì—…ë°ì´íŠ¸ í•©ë‹ˆë‹¤.
- âœ¨ ìì›ì— ë½ì„ ê±¸ì–´ì„œ ì„ ì í•˜ì§€ ì•Šê³ , ë™ì‹œì„± ë¬¸ì œê°€ ë°œìƒí•˜ë©´ ê·¸ë•Œê°€ì„œ ì²˜ë¦¬í•˜ëŠ”Â **ë‚™ê´€ì  ë½**Â ë°©ì‹ì…ë‹ˆë‹¤.
- ë‚´ê°€ ì½ì€ ë²„ì „ì—ì„œ ìˆ˜ì •ì‚¬í•­ì´ ìƒê²¼ì„ ê²½ìš°ì—ëŠ” applicationì—ì„œ ë‹¤ì‹œ ì½ì€ í›„ì— ì‘ì—…ì„ ìˆ˜í–‰í•˜ëŠ” ë¡¤ë°± ì‘ì—…ì„ ìˆ˜í–‰í•´ì•¼ í•©ë‹ˆë‹¤.

[ê³¼ì •]

1) ì„œë²„ 1ì´ version1 ì„ì„ ì¡°ê±´ì ˆì— ëª…ì‹œí•˜ë©´ì„œ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ë¥¼ ë‚ ë¦½ë‹ˆë‹¤.

2) version1 ì¿¼ë¦¬ê°€ ì—…ë°ì´íŠ¸ ë˜ì–´ì„œ, ë””ë¹„ëŠ” version 2ê°€ ë©ë‹ˆë‹¤.

![](https://blog.kakaocdn.net/dn/dKqfxu/btrNvi6tcWA/VY4ayDO2LtYNK0I13Re1PK/img.png)

Optimisitc Lock ì ìœ  ê³¼ì •

3) server2 ê°€ version1 ë¡œ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ë©´ ë²„ì „ì´ ë§ì§€ì•Šì•„ ì‹¤íŒ¨í•©ë‹ˆë‹¤.

4) ì¿¼ë¦¬ê°€ ì‹¤íŒ¨í•˜ë©´ server2 ì—ì„œ ë‹¤ì‹œ ì¡°íšŒí•˜ì—¬ ë²„ì „ì„ ë§ì¶˜ í›„ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ëŠ” ê³¼ì •ì„ ê±°ì¹©ë‹ˆë‹¤.

![](https://blog.kakaocdn.net/dn/ldJlh/btrNuRuEfAz/KzxNdqnBgIEykORQzUkOhk/img.png)

Optimisitc Lock ì ìœ  ê³¼ì •


- ì¥ì 
    - ë³„ë„ì˜ Lock ì„ ì ìœ í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì„±ëŠ¥ìƒì˜ ì´ì ì´ ìˆë‹¤.

- ë‹¨ì 
- update ì‹¤íŒ¨ì‹œ ì¬ì‹œë„ ë¡œì§ì„ ê°œë°œìê°€ ì‘ì„±í•´ì•¼í•¨
- ì¶©ëŒì´ ë¹ˆë²ˆí•˜ë©´ Pessimistic Lockì— ë¹„í•´ ì„±ëŠ¥ì´ ë–¨ì–´ì§ˆ ìˆ˜ë„ ìˆë‹¤.

**ì„œë¹„ìŠ¤**
```
@Service  
public class OptimisticLockStockService {  
  
@Autowired  
private StockRepository stockRepository;  
  
@Transactional  
public void decrease(Long id, Long quantity){  
	Stock stock = stockRepository.findByIdWithOptimisticLock(id);  
	  
	stock.decrease(quantity);  
	  
	stockRepository.saveAndFlush(stock);  
}  
  
}
```

**í¼ì‚¬ë“œ**
```
@Service  
public class OptimisticLockStockFacade {  
  
	@Autowired  
	private OptimisticLockStockService optimisticLockService;  
	  
	/**  
	* OptimisticLock ì€ ì‹¤íŒ¨ì‹œ ì¬ì‹œë„ê°€ í•„ìš”í•¨ìœ¼ë¡œ while break ë¬¸ ì ìš©  
	* */  
	  
	public void decrease(Long id, Long quantity) throws InterruptedException {  
		while (true){  
			try{  
				optimisticLockService.decrease(id,quantity);   
				break;  
				}catch (Exception e){  
					Thread.sleep(50);  
				}  
			}  
	}  
}
```
**ë ˆí¬ì§€í† ë¦¬**
```
@Repository  
public interface StockRepository extends JpaRepository<Stock,Long> {  
	/**  
	* ë¹„ê´€ì  ë½(Pessimistic Lock)  
	*  
	*/  
	@Lock(value = LockModeType.OPTIMISTIC)  
	@Query("select s from Stock s where s.id = :id")  
	Stock findByIdWithOptimisticLock(@Param("id") final Long id);  
}
```

**í…ŒìŠ¤íŠ¸ ì½”ë“œ**
```
@Test  
public void Optimistic_ë½ì„_ì ìš©í•˜ì—¬_ë™ì‹œì—_100ê°œì˜_ìš”ì²­() throws InterruptedException {  
	int threadCnt = 100;  
	  
	ExecutorService executorService = Executors.newFixedThreadPool(32);  
	CountDownLatch latch = new CountDownLatch(threadCnt);  
	  
	  
	for (int i=0; i< threadCnt; i++){  
		executorService.submit(() -> {  
			try{  
				optimisticLockService.decrease(1l,1l);  
			}catch (InterruptedException e){  
				throw new RuntimeException(e);  
			}finally {  
				latch.countDown();  
			}  
		  
		});  
	}  
	latch.await();  
	  
	Stock stock = stockRepository.findById(1L).orElseThrow();  
	  
	assertEquals(0L,stock.getQuantity());  
}
```


**2. Named Lock**

- Named Lockì€ ì´ë¦„ì„ ê°€ì§„ metadata Lock ì…ë‹ˆë‹¤.
- ì´ë¦„ì„ ê°€ì§„ ë½ì„ íšë“í•œ í›„, í•´ì§€ë ë•Œ ê¹Œì§€ ë‹¤ë¥¸ ì„¸ì…˜ì€ ì´ ë½ì„ íšë“í•  ìˆ˜ ì—†ê²Œ ë©ë‹ˆë‹¤.
- ì£¼ì˜í•  ì ì€, íŠ¸ëœì­ì…˜ì´ ì¢…ë£Œë  ë–„ ë½ì´ ìë™ìœ¼ë¡œ í•´ì§€ë˜ì§€ ì•Šê¸° ë–„ë¬¸ì—, ë³„ë„ë¡œ í•´ì§€í•´ì£¼ê±°ë‚˜ ì„ ì ì‹œê°„ì´ ëë‚˜ì•¼ í•´ì§€ë©ë‹ˆë‹¤.
- Mysql ì—ì„œëŠ” getLock( ) ì„ í†µí•´ íšë“¤ / releaseLock() ìœ¼ë¡œ í•´ì§€ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

[Named lock ì‹œ Lock ì ìœ  ê³¼ì •]

1. Named Lockì€ Stockì— ë½ì„ ê±¸ì§€ ì•Šê³ , ë³„ë„ì˜ ê³µê°„ì— ë½ì„ ê²ë‹ˆë‹¤.
2. session-1 ì´ 1ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ë½ì„ ê±´ë‹¤ë©´, session 1 ì´ 1ì„ í•´ì§€í•œ í›„ì— ë½ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![](https://blog.kakaocdn.net/dn/mZ7OR/btrNuoG3FK5/i0JEKOPVKNQon8sUgc29s1/img.png)

Named Lock ì ìœ  ê³¼ì •

_âš¡ï¸ Named Lock ì‚¬ìš©ì‹œ ì£¼ì˜ì‚¬í•­_

- ì˜ˆì œì—ì„œëŠ” ë™ì¼í•œ DataSource ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ì»¤ë„¥ì…˜í’€ì´ ë¶€ì¡±í•´ì§ˆ ìˆ˜ ìˆê¸°ì— DataSoruce ë¥¼ ë¶„ë¦¬í•˜ëŠ” ê±¸ ì¶”ì²œí•œë‹¤ê³  í•©ë‹ˆë‹¤.

**ğŸ–¥LockRepository**Â 

- ì˜ˆì œì—ì„œëŠ” í¸ì˜ì„±ì„ ìœ„í•´ì„œ Stock ì—”í‹°í‹°ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ì‹¤ë¬´ì—ì„œëŠ” ë³„ë„ì˜ JDBC ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤ê³  í•©ë‹ˆë‹¤.

```
public interface LockRepository extends JpaRepository<Stock, Long> {

    @Query(value = "select get_lock(:key, 3000)", nativeQuery = true)
    void getLock(String key);

    @Query(value = "select release_lock(:key, key)", nativeQuery = true)
    void releaseLock(String key);
}
```

**ğŸ–¥ NamedLockFacde**

- StockService ëŠ” ë¶€ëª¨ì˜ íŠ¸ëœì­ì…˜ê³¼ ë³„ë„ë¡œ ì‹¤í–‰ë˜ì–´ì•¼í•˜ê¸° ë•Œë¬¸ì— propergationì„ ë³„ë„ë¡œ ìƒì„±í•´ì¤ë‹ˆë‹¤
- ë¶€ëª¨ì˜ íŠ¸ëœì­ì…˜ê³¼ ë™ì¼í•œ ë²”ìœ„ë¡œ ë¬¶ì¸ë‹¤ë©´ Synchronized ì™€ ê°™ì€ ë¬¸ì œì¸ DataBaseì— commit ë˜ê¸°ì „ì— ë½ì´ í’€ë¦¬ëŠ” í˜„ìƒì´ ë°œìƒí•©ë‹ˆë‹¤.
- ê·¸ë ‡ê¸° ë•Œë¬¸ì— ë³„ë„ì˜ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¶„ë¦¬í•´ì„œ DataBaseì— ì •ìƒì ìœ¼ë¡œ Commitì´ ëœ í›„ì— ë½ì„ í•´ì œí•´ ì£¼ë ¤ëŠ” ì˜ë„ë¥´ í’ˆê³ ìˆë‹¤ê³ í•©ë‹ˆë‹¤.
- í•µì‹¬ì€ Lockì„ í•´ì œí•˜ê¸°ì „ì— DataBaseì— Commitì´ ë˜ë„ë¡ í•˜ëŠ”ê²ƒ..!!

```
@Component
@RequiredArgsConstructor
public class NamedLockFacade {

    private final LockRepository lockRepository;
    private final StockService stockService;

    //ë¶€ëª¨ì˜ íŠ¸ëœì­ì…˜ê³¼ ë³„ë„ë¡œ ì‹¤í–‰ë˜ì–´ì•¼ í•¨
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void decrease(final Long id, final Long quantity) {
        try {
            lockRepository.getLock(id.toString());
            stockService.decrease(id, quantity);
        }finally {
            //ë½ì˜ í•´ì œ
            lockRepository.releaseLock(id.toString());
        }
    }
}
```

ë½ì„ íšë“í•œ í›„, ë¹„ì§€ë‹ˆìŠ¤ ë¡œì§ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.

ê·¸ í›„ finally ì—ì„œ ë½ì„ í•´ì§€í•´ì¤ë‹ˆë‹¤.

ê·¸ë¦¬êµ¬ ì˜ˆì œì—ì„œëŠ” ê°™ì€ DataSource ë¥¼ ì‚¬ìš©í•´ì£¼ì–´ì•¼í•˜ê¸° ë•Œë¬¸ì— ì»¤ë„¥ì…˜ í’€ ìˆ˜ë¥¼ ëŠ˜ë ¤ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.

```
spring:
  jpa:
    hibernate:
      ddl-auto: create
    show-sql: true
  datasource:
    driver-class-name: org.h2.Driver
    url:  jdbc:h2:tcp://localhost/~/test
    username: sa
    password:
    hikari:
      maximum-pool-size: 40
```

ğŸ–¥Â **NamedFacadeTest**

```
@SpringBootTest
class NamedLockFacadeTest {

    @Autowired
    private NamedLockFacade stockFacade;

    @Autowired
    private StockRepository stockRepository;

    @BeforeEach
    public void before() {
        Stock stock = new Stock(1L, 100L);
        stockRepository.saveAndFlush(stock);
    }

    @AfterEach
    public void after() {
        stockRepository.deleteAll();
    }


    @Test
    @DisplayName("Pessimistic LOCK ë™ì‹œì—_100ê°œì˜_ìš”ì²­")
    public void Pessimistic_requests_100_AtTheSameTime() throws InterruptedException {
        int threadCount = 100;
        //ë©€í‹°ìŠ¤ë ˆë“œ ì´ìš© ExecutorService : ë¹„ë™ê¸°ë¥¼ ë‹¨ìˆœí•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆë˜ë¡ í•´ì£¼ëŠ” java api
        ExecutorService executorService = Executors.newFixedThreadPool(32);

        //ë‹¤ë¥¸ ìŠ¤ë ˆë“œì—ì„œ ìˆ˜í–‰ì´ ì™„ë£Œë  ë•Œ ê¹Œì§€ ëŒ€ê¸°í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” API - ìš”ì²­ì´ ëë‚ ë•Œ ê¹Œì§€ ê¸°ë‹¤ë¦¼
        CountDownLatch latch = new CountDownLatch(threadCount);

        for (int i = 0; i < threadCount; i++) {
            executorService.submit(() -> {
                    try {
                        stockFacade.decrease(1L, 1L);
                    } finally {
                        latch.countDown();
                    }
                }
            );
        }

        latch.await();

        Stock stock = stockRepository.findById(1L).orElseThrow();

        //100 - (1*100) = 0
        assertThat(stock.getQuantity()).isEqualTo(0L);
    }
}
```

**ğŸ“™ Named Lock ì´ ì¥ì **

- ğŸ“Œ NamedLock ì€ ì£¼ë¡œ ë¶„ì‚°ë½ì„ êµ¬í˜„í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
- Pessimistic ë½ì€ time outì„ êµ¬í˜„í•˜ê¸° êµ‰ì¥íˆ í˜ë“¤ì§€ë§Œ, Named Lockì€ ë¹„êµì  ì†ì‰½ê²Œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤ê³  í•©ë‹ˆë‹¤.
- ê·¸ ì™¸ì—, ë°ì´í„° ì •í•©ì„±ì„ ë§ì¶°ì•¼í•˜ëŠ” ê²½ìš°ì—ë„ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ê³  í•©ë‹ˆë‹¤.

**ğŸ“˜ Named Lock ì´ ë‹¨ì **

- í•˜ì§€ë§Œ., Naemd Lock ì€ íŠ¸ëœì­ì…˜ ì¢…ë£Œ ì‹œì—, ë½ í•´ì œì™€ ì„¸ì…˜ê´€ë¦¬ë¥¼ ì˜ í•´ì£¼ì–´ì•¼í•˜ë¯€ë¡œ ì£¼ì˜í•´ì„œ ì‚¬ìš©ì£¼ì–´ì•¼ í•©ë‹ˆë‹¤.
- ë˜ ì‹¤ì œ ì‚¬ìš©í•  ë•ŒëŠ” êµ¬í˜„ë°©ë²•ì´, ë³µì¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.


ì¶œì²˜: https://thalals.tistory.com/370